<!-- Navbar -->
<app-navbar></app-navbar>

<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h4 mb-0">
          <i class="bi bi-person-plus me-2"></i>
          {{ isEditMode ? 'Editar Usuário' : 'Novo Usuário' }}
        </h2>
        <a routerLink="/users" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>
          Voltar
        </a>
      </div>

      <!-- Mensagem de erro geral -->
      <div *ngIf="errorMessage" class="alert alert-danger" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        {{ errorMessage }}
      </div>

      <!-- Loading inicial (quando está carregando usuário para edição) -->
      <div *ngIf="initialLoading" class="text-center py-5">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2 text-muted">Carregando dados do usuário...</p>
      </div>

      <!-- Formulário -->
      <div *ngIf="!initialLoading" class="card">
        <div class="card-body">
          <form [formGroup]="userForm" (ngSubmit)="onSubmit()" novalidate>
            <div class="row">
              <!-- Nome -->
              <div class="col-md-6 mb-3">
                <label for="nome" class="form-label">Nome Completo *</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-person"></i>
                  </span>
                  <input
                    type="text"
                    id="nome"
                    class="form-control"
                    [class.is-invalid]="hasFieldError('nome')"
                    formControlName="nome"
                    placeholder="Digite o nome completo"
                  />
                  <div *ngIf="hasFieldError('nome')" class="invalid-feedback">
                    {{ getFieldError('nome') }}
                  </div>
                </div>
              </div>

              <!-- Email -->
              <div class="col-md-6 mb-3">
                <label for="email" class="form-label">Email *</label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-envelope"></i>
                  </span>
                  <input
                    type="email"
                    id="email"
                    class="form-control"
                    [class.is-invalid]="hasFieldError('email')"
                    formControlName="email"
                    placeholder="email@exemplo.com"
                  />
                  <div *ngIf="hasFieldError('email')" class="invalid-feedback">
                    {{ getFieldError('email') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Campos de senha -->
            <div class="row">
              <!-- Senha -->
              <div class="col-md-6 mb-3">
                <label for="password" class="form-label">
                  {{ isEditMode ? 'Nova Senha (opcional)' : 'Senha *' }}
                </label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-lock"></i>
                  </span>
                  <input
                    type="password"
                    id="password"
                    class="form-control"
                    [class.is-invalid]="hasFieldError('password')"
                    formControlName="password"
                    [placeholder]="isEditMode ? 'Deixe vazio para manter a senha atual' : 'Mínimo 6 caracteres'"
                  />
                  <div *ngIf="hasFieldError('password')" class="invalid-feedback">
                    {{ getFieldError('password') }}
                  </div>
                </div>
                <small *ngIf="isEditMode" class="form-text text-muted">
                  Preencha apenas se quiser alterar a senha atual
                </small>
              </div>

              <!-- Confirmação de Senha -->
              <div class="col-md-6 mb-3">
                <label for="password_confirmation" class="form-label">
                  {{ isEditMode ? 'Confirmar Nova Senha' : 'Confirmar Senha *' }}
                </label>
                <div class="input-group">
                  <span class="input-group-text">
                    <i class="bi bi-lock-fill"></i>
                  </span>
                  <input
                    type="password"
                    id="password_confirmation"
                    class="form-control"
                    [class.is-invalid]="hasFieldError('password_confirmation')"
                    formControlName="password_confirmation"
                    placeholder="Digite a senha novamente"
                  />
                  <div *ngIf="hasFieldError('password_confirmation')" class="invalid-feedback">
                    {{ getFieldError('password_confirmation') }}
                  </div>
                </div>
              </div>
            </div>

            <!-- Status -->
            <div class="row">
              <div class="col-12 mb-3">
                <label class="form-label">Status</label>
                <div class="form-check form-switch">
                  <input 
                    class="form-check-input" 
                    type="checkbox" 
                    id="ativo"
                    formControlName="ativo"
                  />
                  <label class="form-check-label" for="ativo">
                    <span *ngIf="userForm.get('ativo')?.value" class="text-success">
                      <i class="bi bi-check-circle me-1"></i>
                      Usuário ativo
                    </span>
                    <span *ngIf="!userForm.get('ativo')?.value" class="text-danger">
                      <i class="bi bi-x-circle me-1"></i>
                      Usuário inativo
                    </span>
                  </label>
                </div>
                <small class="form-text text-muted">
                  Usuários inativos não poderão fazer login no sistema
                </small>
              </div>
            </div>

            <!-- Botões -->
            <div class="row">
              <div class="col-12">
                <div class="d-flex gap-2">
                  <button
                    type="submit"
                    class="btn btn-primary"
                    [disabled]="isLoading || !isFormValid()"
                  >
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status">
                      <span class="visually-hidden">Carregando...</span>
                    </span>
                    <i *ngIf="!isLoading" class="bi bi-check-circle me-2"></i>
                    {{ isLoading ? 'Salvando...' : (isEditMode ? 'Atualizar' : 'Criar') }}
                  </button>
                  
                  <a routerLink="/users" class="btn btn-outline-secondary">
                    Cancelar
                  </a>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Informações adicionais para edição -->
      <div *ngIf="isEditMode && currentUser && !initialLoading" class="card mt-3">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="bi bi-info-circle me-2"></i>
            Informações Adicionais
          </h6>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>ID:</strong> {{ currentUser.id }}<br>
              <strong>Cadastrado em:</strong> {{ formatDate(currentUser.created_at) }}
            </div>
            <div class="col-md-6">
              <strong>Última atualização:</strong> {{ formatDate(currentUser.updated_at) }}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>